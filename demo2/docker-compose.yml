version: "3.8"

# ─────────────────────────────────────────────────────────────
#  PDF & Image OCR Extraction Stack
#
#  Uses LocalStack COMMUNITY edition (no Pro features).
#
#  Since LAMBDA_RUNTIME_IMAGE_MAPPING is Pro-only, we use a
#  Lambda LAYER to inject Tesseract + Poppler binaries into
#  the standard python3.11 Lambda container at /opt.
#
#  Startup order:
#    1. layer-builder  → builds Tesseract layer zip (Amazon Linux 2023)
#    2. localstack     → starts (latest community)
#    3. deployer       → publishes layer, creates function, waits Active
#    4. backend        → Flask API (starts after deployer confirms Active)
#    5. frontend       → Nginx + Tailwind CSS
# ─────────────────────────────────────────────────────────────

services:

  # ── 1. Build Tesseract + Poppler Lambda Layer ────────────
  # Uses amazonlinux:2023 (same OS as Lambda python3.11 runtime)
  # to ensure binary compatibility. Outputs /out/layer.zip.
  layer-builder:
    image: amazonlinux:2023
    container_name: ocr-layer-builder
    volumes:
      - ./layer-builder/build-layer.sh:/build-layer.sh:ro
      - layer-data:/out
    entrypoint: ["/bin/bash", "/build-layer.sh"]

  # ── 2. LocalStack Community ──────────────────────────────
  localstack:
    image: localstack/localstack:latest
    container_name: ocr-localstack
    ports:
      - "4566:4566"
    environment:
      - SERVICES=lambda,iam,logs
      - DEBUG=1
      - EAGER_SERVICE_LOADING=1
      # Lambda containers need Docker socket + same network
      - LAMBDA_DOCKER_NETWORK=ocr-net
    volumes:
      # REQUIRED for Lambda: LocalStack spawns separate containers
      - /var/run/docker.sock:/var/run/docker.sock
      - localstack-data:/var/lib/localstack
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:4566/_localstack/health"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 10s
    depends_on:
      layer-builder:
        condition: service_completed_successfully
    networks:
      - ocr-net

  # ── 3. Deployer: publish layer + create function ─────────
  deployer:
    build: ./deployer
    container_name: ocr-deployer
    volumes:
      - layer-data:/layers:ro
      - ./lambda/handler.py:/src/handler.py:ro
    environment:
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1
    depends_on:
      localstack:
        condition: service_healthy
    networks:
      - ocr-net

  # ── 4. Flask Backend ─────────────────────────────────────
  backend:
    build: ./backend
    container_name: ocr-backend
    ports:
      - "5000:5000"
    environment:
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1
      - LOCALSTACK_ENDPOINT=http://localstack:4566
      - LAMBDA_FUNCTION_NAME=ocr-extract
    depends_on:
      deployer:
        condition: service_completed_successfully
    networks:
      - ocr-net

  # ── 5. Nginx Frontend ───────────────────────────────────
  frontend:
    build: ./frontend
    container_name: ocr-frontend
    ports:
      - "8080:80"
    depends_on:
      - backend
    networks:
      - ocr-net

volumes:
  localstack-data:
  layer-data:

networks:
  ocr-net:
    name: ocr-net
    driver: bridge
