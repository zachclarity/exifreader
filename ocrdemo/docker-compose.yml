version: "3.8"

services:
  # ── Web Server (static HTML + reverse proxy) ──
  web:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./app:/usr/share/nginx/html:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      localstack:
        condition: service_healthy
    restart: unless-stopped

  # ── LocalStack (Lambda runtime with Tesseract OCR) ──
  localstack:
    build:
      context: ./localstack
      dockerfile: Dockerfile
    ports:
      - "4566:4566"
    environment:
      - SERVICES=lambda
      - EAGER_SERVICE_LOADING=1
      - DEBUG=1
      # Force Lambda to run INSIDE this container (where tesseract is installed)
      - LAMBDA_EXECUTOR=local
      # CORS
      - DISABLE_CORS_CHECKS=1
      - DISABLE_CUSTOM_CORS_APIGATEWAY=1
      - EXTRA_CORS_ALLOWED_ORIGINS=http://localhost:8080,http://localhost
    volumes:
      - ./init/setup.sh:/etc/localstack/init/ready.d/setup.sh
      - ./lambda:/etc/localstack/init/ready.d/lambda-code:ro
      - localstack_data:/var/lib/localstack
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 15s
    restart: unless-stopped

volumes:
  localstack_data:
