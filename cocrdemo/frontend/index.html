<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LocalStack OCR (Real Tesseract + S3)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-3xl mx-auto p-6">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">LocalStack OCR</h1>
      <span class="text-xs text-slate-400">Tesseract (image if supported) + S3 pipeline</span>
    </div>

    <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-5 shadow">
      <label class="block text-sm font-medium text-slate-200 mb-2">Upload an image</label>
      <input id="fileInput" type="file" accept="image/*"
             class="block w-full text-sm text-slate-200
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-lg file:border-0
                    file:text-sm file:font-semibold
                    file:bg-slate-700 file:text-slate-100
                    hover:file:bg-slate-600
                    bg-slate-950 border border-slate-800 rounded-lg p-2" />

      <div class="mt-4 flex gap-3">
        <button id="processBtn"
                class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 active:bg-indigo-700 font-semibold">
          Process OCR
        </button>
        <button id="clearBtn"
                class="px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 font-semibold">
          Clear
        </button>
      </div>

      <div class="mt-6 grid grid-cols-1 gap-4">
        <div class="bg-slate-950 border border-slate-800 rounded-xl p-4">
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-slate-200">Extracted Text</h2>
            <span id="status" class="text-xs text-slate-400"></span>
          </div>
          <pre id="extractedText" class="mt-3 whitespace-pre-wrap text-slate-100 text-sm"></pre>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-slate-950 border border-slate-800 rounded-xl p-4">
            <h2 class="text-sm font-semibold text-slate-200">Processing Time (ms)</h2>
            <div id="processingTime" class="mt-2 text-2xl font-bold text-slate-100">—</div>
          </div>
          <div class="bg-slate-950 border border-slate-800 rounded-xl p-4 md:col-span-2">
            <h2 class="text-sm font-semibold text-slate-200">Stored In S3</h2>
            <div class="mt-2 text-xs text-slate-300">
              <div><span class="text-slate-400">bucket:</span> <code id="s3Bucket">—</code></div>
              <div class="mt-1"><span class="text-slate-400">key:</span> <code id="s3Key">—</code></div>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-6 text-xs text-slate-400">
        <div><span class="font-semibold text-slate-300">Lambda URL:</span> <code id="lambdaUrlLabel"></code></div>
        <div class="mt-1">CORS is enabled on the Lambda Function URL by the init script.</div>
      </div>
    </div>
  </div>

<script>
  const LAMBDA_FUNCTION_NAME = "ocr-lambda";
  const LAMBDA_URL = `http://localhost:4566/lambda-url/${LAMBDA_FUNCTION_NAME}/`;

  const fileInput = document.getElementById("fileInput");
  const processBtn = document.getElementById("processBtn");
  const clearBtn = document.getElementById("clearBtn");
  const extractedText = document.getElementById("extractedText");
  const processingTime = document.getElementById("processingTime");
  const statusEl = document.getElementById("status");
  const s3BucketEl = document.getElementById("s3Bucket");
  const s3KeyEl = document.getElementById("s3Key");

  document.getElementById("lambdaUrlLabel").textContent = LAMBDA_URL;

  clearBtn.addEventListener("click", () => {
    fileInput.value = "";
    extractedText.textContent = "";
    processingTime.textContent = "—";
    statusEl.textContent = "";
    s3BucketEl.textContent = "—";
    s3KeyEl.textContent = "—";
  });

  processBtn.addEventListener("click", uploadAndProcess);

  // Upload pipeline: browser -> Lambda (base64) -> Lambda stores to S3 -> Lambda runs OCR -> returns text + timing + S3 key
  async function uploadAndProcess() {
    try {
      const file = fileInput.files?.[0];
      if (!file) { alert("Please choose an image file first."); return; }
      if (!file.type.startsWith("image/")) { alert("Images only."); return; }

      setBusy(true, "Encoding image…");
      const base64 = await fileToBase64(file);

      const payload = {
        filename: file.name,
        contentType: file.type,
        imageBase64: base64,
        storeToS3: true
      };

      setBusy(true, "Calling Lambda…");
      const resp = await fetch(LAMBDA_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!resp.ok) {
        const errText = await resp.text().catch(() => "");
        throw new Error(`Lambda HTTP ${resp.status}: ${errText || resp.statusText}`);
      }

      const data = await resp.json();
      extractedText.textContent = data.text ?? "(no text returned)";
      processingTime.textContent = String(data.processingTimeMs ?? "—");
      s3BucketEl.textContent = data.s3Bucket ?? "—";
      s3KeyEl.textContent = data.s3Key ?? "—";

      setBusy(false, "Done");
      setTimeout(() => statusEl.textContent = "", 1500);
    } catch (err) {
      console.error(err);
      setBusy(false, "Error");
      alert(`Error: ${err.message}`);
    }
  }

  function setBusy(isBusy, msg) {
    processBtn.disabled = isBusy;
    processBtn.classList.toggle("opacity-60", isBusy);
    processBtn.classList.toggle("cursor-not-allowed", isBusy);
    statusEl.textContent = msg || "";
  }

  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = () => reject(new Error("Failed to read file"));
      reader.onload = () => {
        const s = String(reader.result);
        const comma = s.indexOf(",");
        resolve(comma >= 0 ? s.slice(comma + 1) : s);
      };
      reader.readAsDataURL(file);
    });
  }
</script>
</body>
</html>
